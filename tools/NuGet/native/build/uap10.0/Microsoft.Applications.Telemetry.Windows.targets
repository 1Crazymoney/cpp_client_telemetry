<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <AriaPlatform Condition="'$(Platform)' == 'Win32'">x86</AriaPlatform>
    <AriaPlatform Condition="'$(Platform)' != 'Win32'">$(Platform)</AriaPlatform>
    <ConfigurationName Condition="'$(Configuration)' != ''">$(Configuration)</ConfigurationName>
    <AriaWinmd>$(MSBuildThisFileDirectory)../../lib/uap10.0/$(ConfigurationName)/$(AriaPlatform)/Microsoft.Applications.Telemetry.Windows.winmd</AriaWinmd>
    <AriaDll>$(MSBuildThisFileDirectory)../../lib/uap10.0/$(ConfigurationName)/$(AriaPlatform)/Microsoft.Applications.Telemetry.Windows-native.dll</AriaDll>
  </PropertyGroup>

  <Target Name="PlatformCheck" BeforeTargets="InjectReference"
    Condition=" ( ('$(AriaPlatform)' != 'x86') AND ('$(AriaPlatform)' != 'ARM') AND  ('$(AriaPlatform)' != 'x64') )">
    <Error  Text="$(MSBuildThisFileName) does not work correctly on '$(Platform)' platform. You need to specify platform (x86 / x64 or ARM)." />
  </Target>

  <ItemDefinitionGroup Condition="'$(TargetPlatformIdentifier)' == 'UAP'">
    <ClCompile>
      <AdditionalIncludeDirectories>$(MSBuildThisFileDirectory)../../include/;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
    </ClCompile>
    <ResourceCompile>
      <AdditionalIncludeDirectories>$(MSBuildThisFileDirectory)../../include/;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
    </ResourceCompile>
    <Link>
      <AdditionalDependencies>$(MSBuildThisFileDirectory)../../lib/uap10.0/$(ConfigurationName)/$(AriaPlatform)/Microsoft.Applications.Telemetry.Windows.native.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>

  <Target Name="InjectReference" BeforeTargets="ResolveAssemblyReferences" Condition="'$(TargetPlatformIdentifier)' == 'UAP'">
    <Message Importance="high" Text="ResolveAssemblyReferences for $(TargetPlatformIdentifier) - $(AriaPlatform) ..." />
    <ItemGroup>
      <ReferenceCopyLocalPaths Include="$(AriaDll)" />
      <SDKReference Include="Microsoft.VCLibs, Version=14.0" />
    </ItemGroup>
  </Target>

  <!-- If the project.json file is missing assume a packages.config based project and add the NuGet v3 assets.  -->
  <ItemGroup Condition="!Exists('project.json') AND !Exists('$(MSBuildProjectName).project.json') AND '$(TargetPlatformIdentifier)' == 'UAP'">
    <Reference Include="$(AriaWinmd)">
      <HintPath>$(AriaWinmd)</HintPath>
      <Implementation>Microsoft.Applications.Telemetry.Windows.native.dll</Implementation>
    </Reference>
    <ReferenceCopyLocalPaths Include="$(AriaDll)" />
  </ItemGroup>

  <ItemGroup>
    <AvailableItemName Include="NativeBinary" />
  </ItemGroup>

  <ItemGroup>
    <NativeBinary Include="$(MSBuildThisFileDirectory)../../lib/uap10.0/$(ConfigurationName)/$(AriaPlatform)/Microsoft.Applications.Telemetry.Windows.native.dll" />
  </ItemGroup>

  <PropertyGroup>
    <PrepareForRunDependsOn>
      $(PrepareForRunDependsOn);
      CopyNativeBinaries
    </PrepareForRunDependsOn>
  </PropertyGroup>

  <Target Name="CopyNativeBinaries" DependsOnTargets="CopyFilesToOutputDirectory">
    <Message Text="Copying .dll to $(OutputPath)..." />
    <Copy SourceFiles="@(NativeBinary)" DestinationFiles="@(NativeBinary->'$(OutputPath)\%(Filename).dll')">
      <Output TaskParameter="DestinationFiles" ItemName="FileWrites" />
    </Copy>
  </Target>

</Project>
