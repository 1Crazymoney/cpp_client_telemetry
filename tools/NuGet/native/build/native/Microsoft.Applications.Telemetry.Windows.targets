<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <AriaPlatform Condition="'$(Platform)' == 'Win32'">x86</AriaPlatform>
    <AriaPlatform Condition="'$(Platform)' != 'Win32'">$(Platform)</AriaPlatform>
    <ConfigurationName Condition="'$(Configuration)' != ''">$(Configuration)</ConfigurationName>
    <AriaWinmd>$(MSBuildThisFileDirectory)../../lib/uap10.0/$(ConfigurationName)/$(AriaPlatform)/Microsoft.Applications.Telemetry.Windows.winmd</AriaWinmd>
    <AriaDll Condition="'$(TargetPlatformIdentifier)' == 'UAP'">$(MSBuildThisFileDirectory)../../lib/uap10.0/$(ConfigurationName)/$(AriaPlatform)/Microsoft.Applications.Telemetry.Windows-native.dll</AriaDll>
    <AriaDll Condition="'$(TargetPlatformIdentifier)' != 'UAP' AND '$(WindowsAppContainer)' != 'true'">$(MSBuildThisFileDirectory)../../lib/native/win32-dll-vs2015/$(AriaPlatform)/$(ConfigurationName)/ClientTelemetry.dll</AriaDll>
  </PropertyGroup>

  <Target Name="PlatformCheck" BeforeTargets="InjectReference" Condition=" ( ('$(AriaPlatform)' != 'x86') AND ('$(AriaPlatform)' != 'ARM') AND  ('$(AriaPlatform)' != 'x64') )">
    <Error Text="$(MSBuildThisFileName) does not work correctly on '$(Platform)' platform. You need to specify platform (x86 / x64 or ARM)." />
  </Target>

  <!-- Windows 10 Universal Store .dll for Visual Studio 2015 -->
  <ItemDefinitionGroup Condition="'$(TargetPlatformIdentifier)' == 'UAP'">
    <ClCompile>
      <AdditionalIncludeDirectories>$(MSBuildThisFileDirectory)../../include/;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
    </ClCompile>
    <ResourceCompile>
      <AdditionalIncludeDirectories>$(MSBuildThisFileDirectory)../../include/;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
    </ResourceCompile>
    <Link>
      <AdditionalLibraryDirectories>$(MSBuildThisFileDirectory)../../lib/uap10.0/$(ConfigurationName)/$(AriaPlatform)/;%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>
      <AdditionalDependencies>Microsoft.Applications.Telemetry.Windows-native.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>

  <Target Name="InjectReference" BeforeTargets="ResolveAssemblyReferences" Condition="'$(TargetPlatformIdentifier)' == 'UAP'">
    <ItemGroup>
      <ReferenceCopyLocalPaths Include="$(AriaDll)" />
      <SDKReference Include="Microsoft.VCLibs, Version=14.0" />
    </ItemGroup>
  </Target>

  <!-- If the project.json file is missing assume a packages.config based project and add the NuGet v3 assets.  -->
  <ItemGroup Condition="!Exists('project.json') AND !Exists('$(MSBuildProjectName).project.json') AND '$(TargetPlatformIdentifier)' == 'UAP'">
    <Reference Include="$(AriaWinmd)">
      <HintPath>$(AriaWinmd)</HintPath>
      <Implementation>Microsoft.Applications.Telemetry.Windows-native.dll</Implementation>
    </Reference>
    <ReferenceCopyLocalPaths Include="$(AriaDll)" />
  </ItemGroup>

   <!-- Win32 Desktop .dll for Visual Studio 2015 -->
  <ItemDefinitionGroup Condition="'$(TargetPlatformIdentifier)' != 'UAP' AND '$(WindowsAppContainer)' != 'true'">
    <ClCompile>
      <AdditionalIncludeDirectories>$(MSBuildThisFileDirectory)../../include/;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
    </ClCompile>
    <ResourceCompile>
      <AdditionalIncludeDirectories>$(MSBuildThisFileDirectory)../../include/;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
    </ResourceCompile>
    <Link>
      <AdditionalLibraryDirectories>$(MSBuildThisFileDirectory)../../lib/native/win32-dll-vs2015/$(AriaPlatform)/$(ConfigurationName)/;%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>
      <AdditionalDependencies>ClientTelemetry.lib;%(AdditionalDependencies)</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>

  <PropertyGroup>
    <PrepareForRunDependsOn>
      $(PrepareForRunDependsOn);
      CopyNativeBinaries
    </PrepareForRunDependsOn>
  </PropertyGroup>

  <Target Name="CopyNativeBinaries" DependsOnTargets="CopyFilesToOutputDirectory">
    <Copy SourceFiles="$(AriaDll)" DestinationFolder="$(OutputPath)" >
      <Output TaskParameter="DestinationFiles" ItemName="FileWrites" />
    </Copy>
  </Target>

</Project>
